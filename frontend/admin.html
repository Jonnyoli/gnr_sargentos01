<!DOCTYPE html>
<html lang="pt">
<head>
<meta charset="UTF-8">
<title>Painel Admin</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
/* ------------------ ROOT & GLOBAL ------------------ */
:root {
    --bg: #f1f3f7;
    --card-bg: #ffffff;
    --text: #2a2a2a;
    --text-light: #6d6d6d;
    --primary: #4a90e2;
    --primary-hover: #3a7bcb;
    --radius: 12px;
    --shadow: 0 4px 14px rgba(0,0,0,0.08);
}

body {
    font-family: "Inter", Arial, sans-serif;
    background: var(--bg);
    margin: 0;
    padding: 20px 40px;
    color: var(--text);
}

/* ------------------ HEADER ------------------ */
header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    margin-bottom: 25px;
}

header h1 {
    font-size: 28px;
    font-weight: 700;
}

header .controls {
    display: flex;
    flex-wrap: wrap;
    gap: 12px;
    margin-top: 15px;
}

input, select {
    padding: 10px 12px;
    border-radius: var(--radius);
    border: 1px solid #d1d5db;
    background: white;
    font-size: 14px;
}

button {
    padding: 10px 16px;
    border: none;
    border-radius: var(--radius);
    cursor: pointer;
    color: white;
    background: var(--primary);
    transition: 0.2s;
    font-size: 14px;
    font-weight: 600;
}
button:hover {
    background: var(--primary-hover);
}

/* ------------------ CARDS ------------------ */
.cards {
    display: flex;
    flex-wrap: wrap;
    gap: 20px;
}

.card {
    background: var(--card-bg);
    padding: 20px;
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    flex: 1 1 200px;
    text-align: center;
}

.card h2 {
    font-size: 30px;
    margin: 0;
    color: var(--primary);
}

.card p {
    margin: 5px 0 0;
    font-size: 15px;
    color: var(--text-light);
}

/* ------------------ TABLE ------------------ */
.table-container {
    background: var(--card-bg);
    padding: 20px;
    border-radius: var(--radius);
    margin-top: 25px;
    box-shadow: var(--shadow);
    overflow-x: auto;
}

table {
    width: 100%;
    border-collapse: collapse;
}

th {
    padding: 12px;
    background: #eef1f5;
    text-align: left;
    font-weight: 600;
    cursor: pointer;
    color: #333;
}

td {
    padding: 12px;
    border-bottom: 1px solid #ececec;
}

tr:hover {
    background: #f6f8fb;
}

/* Notas */
.note-low { background-color: #ffe0e0 !important; }
.note-medium { background-color: #fff3cc !important; }
.note-high { background-color: #d9ffd9 !important; }

/* ------------------ CHART ------------------ */
.chart-container {
    margin-top: 30px;
    background: var(--card-bg);
    padding: 25px;
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    max-width: 900px;
}

/* ------------------ TOOLTIP ------------------ */
.tooltip {
    position: absolute;
    background: #333;
    color: white;
    padding: 6px 10px;
    border-radius: 6px;
    font-size: 12px;
    display: none;
    z-index: 1000;
}

</style>
</head>

<body>

<header>
    <h1>Painel Admin</h1>

    <div class="controls">
        <input type="text" id="search" placeholder="Buscar por nome">

        <select id="filterTema">
            <option value="">Todos os temas</option>
            {% set temas = [] %}
            {% for a in avaliacoes %}
                {% set tema = a.get('tema') %}
                {% if tema and tema not in temas %}
                    {% set _ = temas.append(tema) %}
                    <option value="{{ tema }}">{{ tema }}</option>
                {% endif %}
            {% endfor %}
        </select>

        <select id="filterAvaliador">
            <option value="">Todos avaliadores</option>
            {% set avaliadores = [] %}
            {% for a in avaliacoes %}
                {% set nickname = a.get('avaliador', {}).get('global_name') or a.get('avaliador', {}).get('username') %}
                {% if nickname and nickname not in avaliadores %}
                    {% set _ = avaliadores.append(nickname) %}
                    <option value="{{ nickname }}">{{ nickname }}</option>
                {% endif %}
            {% endfor %}
        </select>

        <input type="date" id="filterFrom">
        <input type="date" id="filterTo">

        <button onclick="exportCSV()">Exportar CSV</button>
        <button onclick="logout()">Logout</button>
    </div>
</header>

<div class="cards">
    <div class="card"><h2>{{ avaliacoes|length }}</h2><p>Total Avaliações</p></div>
    <div class="card"><h2>{{ avaliacoes|map(attribute='conduta')|sum / (avaliacoes|length) | round(1) }}</h2><p>Média Conduta</p></div>
    <div class="card"><h2>{{ avaliacoes|map(attribute='nota_detencao')|sum / (avaliacoes|length) | round(1) }}</h2><p>Média Detenção</p></div>
    <div class="card"><h2>{{ avaliacoes|map(attribute='nota_incidente')|sum / (avaliacoes|length) | round(1) }}</h2><p>Média Incidente</p></div>
</div>

<div class="table-container">
    <table id="tableAvaliacoes">
        <thead>
            <tr>
                <th onclick="sortTable(0)">Nome</th>
                <th onclick="sortTable(1)">Tema</th>
                <th onclick="sortTable(2)">Avaliador</th>
                <th onclick="sortTable(3)">Data</th>
                <th onclick="sortTable(4)">Conduta</th>
                <th onclick="sortTable(5)">Detenção</th>
                <th onclick="sortTable(6)">Incidente</th>
            </tr>
        </thead>

        <tbody>
            {% for a in avaliacoes %}
            <tr title="Observação: {{ a.get('incidente_obs', 'Nenhuma') }}">
                <td>{{ a.get('nome', 'N/A') }}</td>
                <td>{{ a.get('tema', 'N/A') }}</td>
                <td>{{ a.get('avaliador', {}).get('global_name') or a.get('avaliador', {}).get('username') or 'Desconhecido' }}</td>
                <td>
                    {% if a.get('data_submissao') %}
                        {{ a.data_submissao.strftime('%d/%m/%Y %H:%M') }}
                    {% else %}-{% endif %}
                </td>

                <td class="{% if a.get('conduta',0) <5 %}note-low{% elif a.get('conduta',0) <8 %}note-medium{% else %}note-high{% endif %}">
                    {{ a.get('conduta',0) }}
                </td>

                <td class="{% if a.get('nota_detencao',0) <5 %}note-low{% elif a.get('nota_detencao',0) <8 %}note-medium{% else %}note-high{% endif %}">
                    {{ a.get('nota_detencao',0) }}
                </td>

                <td class="{% if a.get('nota_incidente',0) <5 %}note-low{% elif a.get('nota_incidente',0) <8 %}note-medium{% else %}note-high{% endif %}">
                    {{ a.get('nota_incidente',0) }}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<div class="chart-container">
    <canvas id="chart"></canvas>
</div>

<script>
// ------------------- PARSE DE DATAS -------------------
function parseTableDate(str) {
    if (!str || str === "-") return null;
    let [day, month, year] = str.split(' ')[0].split('/');
    return new Date(year, month-1, day); // mês começa em 0
}

// ------------------- FILTRO AVANÇADO -------------------
function applyFilters() {
    const search = document.getElementById("search").value.toLowerCase();
    const tema = document.getElementById("filterTema").value;
    const avaliador = document.getElementById("filterAvaliador").value;
    const fromDate = document.getElementById("filterFrom").value ? new Date(document.getElementById("filterFrom").value) : null;
    const toDate = document.getElementById("filterTo").value ? new Date(document.getElementById("filterTo").value) : null;

    const rows = document.querySelectorAll("#tableAvaliacoes tbody tr");
    rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        const rowTema = row.cells[1].innerText;
        const rowAvaliador = row.cells[2].innerText;
        const rowDateObj = parseTableDate(row.cells[3].innerText);

        let show = text.includes(search);
        if (tema) show = show && rowTema === tema;
        if (avaliador) show = show && rowAvaliador === avaliador;

        if (rowDateObj) {
            if (fromDate) show = show && (rowDateObj >= fromDate);
            if (toDate) show = show && (rowDateObj <= toDate);
        } else if (fromDate || toDate) {
            show = false;
        }

        row.style.display = show ? "" : "none";
    });
}

document.getElementById("search").addEventListener("input", applyFilters);
document.getElementById("filterTema").addEventListener("change", applyFilters);
document.getElementById("filterAvaliador").addEventListener("change", applyFilters);
document.getElementById("filterFrom").addEventListener("change", applyFilters);
document.getElementById("filterTo").addEventListener("change", applyFilters);

// ------------------- ORDENAR TABELA -------------------
function sortTable(colIndex) {
    const table = document.getElementById("tableAvaliacoes");
    let switching = true, dir = "asc";
    while (switching) {
        switching = false;
        const rows = table.rows;
        for (let i=1; i<rows.length-1; i++) {
            let x=rows[i].cells[colIndex].innerText, y=rows[i+1].cells[colIndex].innerText;
            if(!isNaN(x) && !isNaN(y)){x=parseFloat(x);y=parseFloat(y);}
            let shouldSwitch = dir==="asc"? x>y:x<y;
            if(shouldSwitch){rows[i].parentNode.insertBefore(rows[i+1], rows[i]); switching=true;}
        }
        if(!switching && dir==="asc") dir="desc", switching=true;
    }
}

// ------------------- EXPORT & LOGOUT -------------------
function exportCSV(){ window.location.href="/export_csv"; }
function logout(){ window.location.href="/frontend/index.html"; }

// ------------------- GRÁFICO INTERATIVO -------------------
const data = {
    labels: [{% for a in avaliacoes %}"{{ a.get('nome','N/A') }}",{% endfor %}],
    datasets: [{
        label: 'Nota Conduta',
        data: [{% for a in avaliacoes %}{{ a.get('conduta',0) }},{% endfor %}],
        backgroundColor: 'rgba(54, 162, 235, 0.5)'
    },{
        label: 'Nota Detenção',
        data: [{% for a in avaliacoes %}{{ a.get('nota_detencao',0) }},{% endfor %}],
        backgroundColor: 'rgba(255, 99, 132, 0.5)'
    },{
        label: 'Nota Incidente',
        data: [{% for a in avaliacoes %}{{ a.get('nota_incidente',0) }},{% endfor %}],
        backgroundColor: 'rgba(75, 192, 192, 0.5)'
    }]
};

new Chart(document.getElementById('chart'), {
    type: 'bar',
    data: data,
    options: { responsive:true, scales:{ y:{ beginAtZero:true, max:10 } } }
});
</script>
</body>
</html>
